# iOSè®¾å¤‡ä¸Šçš„Supabaseå‡­æ®å­˜å‚¨å®‰å…¨åˆ†æ

**é€‚ç”¨èŒƒå›´**: iPhoneå®‰è£…çš„Flutteråº”ç”¨  
**å®‰å…¨ç­‰çº§**: è¯¦ç»†åˆ†æ  
**æ›´æ–°æ—¶é—´**: 2025-01-15

---

## ğŸ“± å½“å‰å­˜å‚¨æœºåˆ¶

### 1. **ç¼–è¯‘æ—¶åµŒå…¥å­˜å‚¨**

å½“ä½¿ç”¨dart-defineæ„å»ºæ—¶ï¼š
```bash
flutter build ios --dart-define=SUPABASE_URL="https://xxx.supabase.co" \
                  --dart-define=SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiJ9..."
```

**ç‰©ç†å­˜å‚¨ä½ç½®**:
```
iPhoneæ–‡ä»¶ç³»ç»Ÿè·¯å¾„:
/var/containers/Bundle/Application/{éšæœºUUID}/Runner.app/
â”œâ”€â”€ Runner                    <- ä¸»æ‰§è¡Œæ–‡ä»¶ (åŒ…å«é…ç½®å¸¸é‡)
â”œâ”€â”€ Info.plist               <- åº”ç”¨å…ƒæ•°æ®
â”œâ”€â”€ Flutter/                 <- Flutterå¼•æ“æ–‡ä»¶
â””â”€â”€ [å…¶ä»–èµ„æºæ–‡ä»¶]

å­˜å‚¨å½¢å¼: ä½œä¸ºå­—ç¬¦ä¸²å¸¸é‡ç¼–è¯‘åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­
```

### 2. **iOSå¤šå±‚å®‰å…¨ä¿æŠ¤**

#### **ç³»ç»Ÿçº§ä¿æŠ¤**
- ğŸ” **ç¡¬ä»¶åŠ å¯†**: æ‰€æœ‰æ•°æ®ä½¿ç”¨AES-256ç¡¬ä»¶åŠ å¯†
- ğŸ” **è®¾å¤‡å¯†é’¥**: æ¯å°è®¾å¤‡æœ‰å”¯ä¸€çš„ç¡¬ä»¶å¯†é’¥(UID)
- ğŸ” **å®‰å…¨å¯åŠ¨**: ä»bootloaderåˆ°kernelçš„ä¿¡ä»»é“¾éªŒè¯

#### **åº”ç”¨çº§ä¿æŠ¤**
- ğŸ›¡ï¸ **åº”ç”¨æ²™ç›’**: æ¯ä¸ªåº”ç”¨è¿è¡Œåœ¨ç‹¬ç«‹çš„æ²™ç›’ç¯å¢ƒ
- ğŸ›¡ï¸ **ä»£ç ç­¾å**: Appleå¼€å‘è€…è¯ä¹¦ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹
- ğŸ›¡ï¸ **è¿è¡Œæ—¶ä¿æŠ¤**: iOSè¿è¡Œæ—¶é˜²æŠ¤æœºåˆ¶

#### **ç”¨æˆ·çº§ä¿æŠ¤**
- ğŸ”’ **è®¾å¤‡é”å®š**: Face ID/Touch ID/å¯†ç ä¿æŠ¤
- ğŸ”’ **åº”ç”¨æƒé™**: ç»†ç²’åº¦çš„åº”ç”¨æƒé™æ§åˆ¶

---

## ğŸ” å®‰å…¨é£é™©åˆ†æ

### âœ… **ç°æœ‰ä¿æŠ¤æªæ–½**

**1. ç‰©ç†è®¿é—®é˜²æŠ¤**
```
æ­£å¸¸æƒ…å†µä¸‹çš„ä¿æŠ¤å±‚æ¬¡:
ç”¨æˆ· â†’ [Face ID/Touch ID] â†’ [è®¾å¤‡å¯†ç ] â†’ [åº”ç”¨æ²™ç›’] â†’ [ç¡¬ä»¶åŠ å¯†] â†’ æ•°æ®
```

**2. æ¶æ„åº”ç”¨é˜²æŠ¤**
- iOSåº”ç”¨æ²™ç›’ç¡®ä¿å…¶ä»–åº”ç”¨æ— æ³•è®¿é—®æˆ‘ä»¬çš„æ•°æ®
- App Storeå®¡æ ¸è¿‡ç¨‹è¿‡æ»¤æ¶æ„åº”ç”¨

**3. ç½‘ç»œä¼ è¾“é˜²æŠ¤**
- æ‰€æœ‰ä¸Supabaseçš„é€šä¿¡éƒ½é€šè¿‡HTTPSåŠ å¯†
- è¯ä¹¦å›ºå®šå¯è¿›ä¸€æ­¥å¢å¼ºå®‰å…¨æ€§

### âš ï¸ **æ½œåœ¨å®‰å…¨é£é™©**

**1. è¶Šç‹±è®¾å¤‡é£é™©** (ä¸­ç­‰é£é™©)
```bash
# åœ¨è¶Šç‹±iPhoneä¸Šï¼Œæ”»å‡»è€…å¯èƒ½ï¼š
# 1. è·å–rootæƒé™
sudo su -

# 2. è®¿é—®åº”ç”¨æ²™ç›’
cd /var/containers/Bundle/Application/{UUID}/Runner.app/

# 3. åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶
otool -s __TEXT __cstring Runner | grep -i supabase
strings Runner | grep -E "(https://|eyJ)"
```

**2. é™æ€åˆ†æé£é™©** (ä¸­ç­‰é£é™©)
```bash
# å¦‚æœæ”»å‡»è€…è·å¾—.ipaæ–‡ä»¶ï¼š
# 1. è§£å‹ipaæ–‡ä»¶
unzip App.ipa

# 2. åˆ†æäºŒè¿›åˆ¶
strings Payload/Runner.app/Runner | grep -i supabase

# 3. å¯èƒ½æå–åˆ°ï¼š
# - Supabase URL: https://xxx.supabase.co
# - APIå¯†é’¥: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**3. å†…å­˜åˆ†æé£é™©** (ä½é£é™©)
```bash
# åœ¨è¿è¡Œæ—¶ï¼Œé…ç½®ä¼šåŠ è½½åˆ°å†…å­˜ä¸­
# é«˜çº§æ”»å‡»è€…å¯èƒ½é€šè¿‡å†…å­˜è½¬å‚¨è·å–å‡­æ®
# ä½†è¿™éœ€è¦è¶Šç‹±è®¾å¤‡ + ä¸“ä¸šå·¥å…·
```

---

## ğŸ›¡ï¸ å¢å¼ºå®‰å…¨å»ºè®®

### 1. **ä»£ç æ··æ·†** (ç«‹å³å®æ–½)

**å¯ç”¨Flutteræ··æ·†**:
```bash
# ç”Ÿäº§æ„å»ºæ—¶å¯ç”¨æ··æ·†
flutter build ios --obfuscate --split-debug-info=debug-info/ \
                  --dart-define=SUPABASE_URL="..." \
                  --dart-define=SUPABASE_ANON_KEY="..."
```

**æ•ˆæœ**:
- ç±»åã€æ–¹æ³•åè¢«æ··æ·†
- å­—ç¬¦ä¸²å¸¸é‡éƒ¨åˆ†æ··æ·†
- å¢åŠ é€†å‘å·¥ç¨‹éš¾åº¦

### 2. **è¿è¡Œæ—¶è§£å¯†** (æ¨èå®æ–½)

**åˆ†ç‰‡å­˜å‚¨é…ç½®**:
```dart
// å°†å®Œæ•´é…ç½®åˆ†è§£ä¸ºå¤šä¸ªç‰‡æ®µ
static const List<String> _urlParts = [
  'aHR0cHM6Ly8=',        // base64: 'https://'
  'eHh4eHh4eHh4',        // base64: project id (æ··æ·†)
  'LnN1cGFiYXNlLmNv'     // base64: '.supabase.co'
];

// è¿è¡Œæ—¶åŠ¨æ€ç»„è£…
String getSupabaseUrl() {
  return _urlParts.map((part) => 
    utf8.decode(base64Decode(part))
  ).join('');
}
```

### 3. **ç¯å¢ƒæ£€æµ‹** (å¢å¼ºå®‰å…¨)

```dart
/// æ£€æµ‹è®¾å¤‡å®‰å…¨çŠ¶æ€
class DeviceSecurityChecker {
  /// æ£€æµ‹æ˜¯å¦ä¸ºè¶Šç‹±è®¾å¤‡
  static bool isJailbroken() {
    // æ£€æŸ¥è¶Šç‹±å·¥å…·è·¯å¾„
    final jailbreakPaths = [
      '/Applications/Cydia.app',
      '/usr/sbin/sshd',
      '/bin/bash',
      '/etc/apt'
    ];
    
    for (final path in jailbreakPaths) {
      if (File(path).existsSync()) {
        return true;
      }
    }
    return false;
  }
  
  /// æ£€æµ‹è°ƒè¯•çŠ¶æ€
  static bool isDebugMode() {
    return Foundation.isDebugMode;
  }
  
  /// ç»¼åˆå®‰å…¨æ£€æŸ¥
  static bool isSecureEnvironment() {
    return !isJailbroken() && !isDebugMode();
  }
}
```

### 4. **åŠ¨æ€é…ç½®è·å–** (æœ€é«˜å®‰å…¨)

```dart
/// ä»æœåŠ¡å™¨åŠ¨æ€è·å–é…ç½®
class DynamicConfigLoader {
  static Future<AppConfig> loadConfig() async {
    // 1. ä»ç¡¬ç¼–ç çš„å¼•å¯¼æœåŠ¡å™¨è·å–çœŸå®é…ç½®
    final bootstrapUrl = 'https://bootstrap.yourdomain.com/config';
    
    // 2. ä½¿ç”¨è®¾å¤‡æŒ‡çº¹éªŒè¯
    final deviceId = await getDeviceId();
    final response = await http.post(bootstrapUrl, body: {
      'device_id': deviceId,
      'app_version': AppConfig.version,
    });
    
    // 3. è§£å¯†é…ç½®
    final encryptedConfig = response.body;
    final config = await decryptConfig(encryptedConfig, deviceId);
    
    return AppConfig.fromJson(config);
  }
}
```

---

## ğŸ“Š é£é™©ç­‰çº§è¯„ä¼°

| å¨èƒåœºæ™¯ | å¯èƒ½æ€§ | å½±å“ç¨‹åº¦ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|---------|-------|---------|---------|---------|
| æ™®é€šç”¨æˆ·è®¾å¤‡è¢«ç›— | ä¸­ç­‰ | ä½ | ğŸŸ¢ ä½ | iOSé”å±ä¿æŠ¤ |
| è¶Šç‹±è®¾å¤‡é™æ€åˆ†æ | ä½ | é«˜ | ğŸŸ¡ ä¸­ç­‰ | ä»£ç æ··æ·† + è¿è¡Œæ—¶è§£å¯† |
| æ¶æ„åº”ç”¨æ”»å‡» | ä½ | ä¸­ç­‰ | ğŸŸ¢ ä½ | iOSæ²™ç›’ä¿æŠ¤ |
| å†…å­˜è½¬å‚¨æ”»å‡» | æä½ | é«˜ | ğŸŸ¢ ä½ | éœ€è¦ç‰©ç†è®¿é—® + ä¸“ä¸šå·¥å…· |
| ä¸­é—´äººæ”»å‡» | ä½ | ä¸­ç­‰ | ğŸŸ¢ ä½ | HTTPS + è¯ä¹¦å›ºå®š |

---

## ğŸš€ å®æ–½ä¼˜å…ˆçº§

### ç«‹å³å®æ–½ (24å°æ—¶å†…)
1. **å¯ç”¨ä»£ç æ··æ·†**
   ```bash
   flutter build ios --obfuscate --split-debug-info=debug-info/
   ```

2. **æ·»åŠ ç¯å¢ƒæ£€æµ‹**
   - æ£€æµ‹è¶Šç‹±è®¾å¤‡
   - åœ¨ä¸å®‰å…¨ç¯å¢ƒä¸­æ‹’ç»è¿è¡Œ

### çŸ­æœŸå®æ–½ (1å‘¨å†…)
1. **å®æ–½é…ç½®åˆ†ç‰‡**
   - å°†URLå’ŒAPIå¯†é’¥åˆ†è§£ä¸ºå¤šä¸ªç‰‡æ®µ
   - è¿è¡Œæ—¶åŠ¨æ€ç»„è£…

2. **å¢å¼ºæ—¥å¿—ç›‘æ§**
   - è®°å½•å¼‚å¸¸è®¿é—®æ¨¡å¼
   - ç›‘æ§å¯ç–‘è®¾å¤‡è¡Œä¸º

### é•¿æœŸè§„åˆ’ (1ä¸ªæœˆå†…)
1. **åŠ¨æ€é…ç½®åŠ è½½**
   - ä»æœåŠ¡å™¨è·å–é…ç½®
   - åŸºäºè®¾å¤‡éªŒè¯çš„é…ç½®ä¸‹å‘

2. **è¯ä¹¦å›ºå®š**
   - å›ºå®šSupabaseæœåŠ¡å™¨è¯ä¹¦
   - é˜²æ­¢ä¸­é—´äººæ”»å‡»

---

## ğŸ”§ ç›‘æ§å’Œæ£€æµ‹

### 1. **å¼‚å¸¸æ£€æµ‹**
```dart
// ç›‘æ§å¼‚å¸¸è®¿é—®æ¨¡å¼
class SecurityMonitor {
  static void logConfigAccess() {
    final timestamp = DateTime.now();
    final context = {
      'is_jailbroken': DeviceSecurityChecker.isJailbroken(),
      'is_debug': DeviceSecurityChecker.isDebugMode(),
      'timestamp': timestamp.toIso8601String(),
    };
    
    // å‘é€åˆ°å®‰å…¨æ—¥å¿—æœåŠ¡
    SecurityLogger.log('CONFIG_ACCESS', context);
  }
}
```

### 2. **å®æ—¶å‘Šè­¦**
- æ£€æµ‹åˆ°è¶Šç‹±è®¾å¤‡æ—¶å‘é€å‘Šè­¦
- å¼‚å¸¸é¢‘ç¹çš„é…ç½®è®¿é—®æ—¶å‘Šè­¦
- å¯ç–‘çš„APIè°ƒç”¨æ¨¡å¼å‘Šè­¦

---

## ğŸ“ æ€»ç»“

**å½“å‰å®‰å…¨çŠ¶æ€**: ğŸŸ¡ **ä¸­ç­‰å®‰å…¨**
- âœ… iOSç³»ç»Ÿçº§ä¿æŠ¤å……åˆ†
- âœ… åº”ç”¨æ²™ç›’éš”ç¦»æœ‰æ•ˆ
- âš ï¸ é™æ€åˆ†æé£é™©å­˜åœ¨

**æ¨èå®‰å…¨ç­‰çº§**: ğŸŸ¢ **é«˜å®‰å…¨**
- å®æ–½ä»£ç æ··æ·†
- æ·»åŠ è¿è¡Œæ—¶è§£å¯†
- ç¯å¢ƒå®‰å…¨æ£€æµ‹

**å…³é”®å»ºè®®**:
1. ç«‹å³å¯ç”¨ä»£ç æ··æ·†æ„å»º
2. å®æ–½é…ç½®åˆ†ç‰‡å’Œè¿è¡Œæ—¶ç»„è£…
3. æ·»åŠ è¶Šç‹±è®¾å¤‡æ£€æµ‹
4. è€ƒè™‘åŠ¨æ€é…ç½®åŠ è½½æœºåˆ¶

é€šè¿‡å®æ–½è¿™äº›æªæ–½ï¼Œå¯ä»¥å°†iOSè®¾å¤‡ä¸Šçš„é…ç½®å®‰å…¨æ€§ä»å½“å‰çš„"ä¸­ç­‰å®‰å…¨"æå‡åˆ°"é«˜å®‰å…¨"çº§åˆ«ã€‚