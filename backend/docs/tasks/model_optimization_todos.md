# 模型优化待办事项

## 优先级说明
- 🔴 高优先级：影响系统一致性和稳定性
- 🟡 中优先级：提升代码质量和可维护性  
- 🟢 低优先级：锦上添花的高级特性

## 1. 模型一致性改进 🔴

### 1.1 统一 EmailAccount 模型
- [ ] 将 EmailAccount 继承自 BaseModel
- [ ] 将主键从 Integer 改为 UUID
- [ ] 将 user_id 从 String(255) 改为 PGUUID
- [ ] 添加 UserOwnedMixin 支持
- [ ] 补充缺失的关系定义

### 1.2 统一模型基类使用
- [ ] 确保所有业务模型都继承 BaseModel
- [ ] 检查并统一所有时间字段使用 timezone-aware
- [ ] 为需要审计的模型添加 AuditMixin

## 2. 业务逻辑分离 🔴

### 2.1 抽取 OCR 处理逻辑
- [ ] 创建 InvoiceOCRService 服务类
- [ ] 将 Invoice.update_from_ocr() 方法移至服务层
- [ ] 将 OCR 格式检测和映射逻辑移至独立模块
- [ ] 创建 OCRResult 数据传输对象

### 2.2 实现仓储模式
- [ ] 创建 BaseRepository 抽象类
- [ ] 实现 InvoiceRepository
- [ ] 实现 ProfileRepository
- [ ] 实现 EmailAccountRepository
- [ ] 将复杂查询逻辑移至仓储层

## 3. 数据验证增强 🟡

### 3.1 添加字段验证器
- [ ] 使用 SQLAlchemy-Utils 添加 Email 验证器
- [ ] 添加金额字段的范围验证
- [ ] 添加日期字段的合理性验证
- [ ] 添加发票号码格式验证

### 3.2 业务规则验证
- [ ] 实现发票号码唯一性验证（考虑软删除）
- [ ] 实现金额一致性验证（不含税 + 税额 = 总额）
- [ ] 实现日期逻辑验证（开票日期不能晚于当前日期）

## 4. 状态管理优化 🟡

### 4.1 实现状态机
- [ ] 集成 transitions 库
- [ ] 定义发票状态转换规则
- [ ] 实现状态转换验证
- [ ] 添加状态转换日志

### 4.2 枚举增强
- [ ] 为所有枚举添加中文描述
- [ ] 实现枚举的 choices 方法
- [ ] 添加枚举值的验证方法

## 5. 事件和监听器 🟡

### 5.1 自动更新时间戳
- [ ] 实现 before_update 事件监听器
- [ ] 自动更新 updated_at 字段
- [ ] 自动更新 last_activity_at 字段

### 5.2 领域事件
- [ ] 创建 DomainEvent 基类
- [ ] 实现 InvoiceCreated 事件
- [ ] 实现 InvoiceVerified 事件
- [ ] 实现 EmailAccountConnected 事件
- [ ] 创建事件发布/订阅机制

## 6. 性能优化 🟢

### 6.1 查询优化
- [ ] 实现查询结果缓存策略
- [ ] 添加批量操作方法
- [ ] 优化 N+1 查询问题
- [ ] 实现延迟加载优化

### 6.2 索引优化
- [ ] 添加函数索引用于常用计算
- [ ] 添加部分索引优化特定场景
- [ ] 分析慢查询并添加必要索引

## 7. 高级特性 🟢

### 7.1 版本控制
- [ ] 为关键模型添加 version 字段
- [ ] 实现乐观锁机制
- [ ] 添加并发更新冲突处理

### 7.2 多租户支持
- [ ] 设计租户隔离方案
- [ ] 添加 tenant_id 字段
- [ ] 实现租户级别的数据隔离

### 7.3 审计日志
- [ ] 创建 AuditLog 模型
- [ ] 实现变更追踪
- [ ] 记录敏感操作

## 8. 序列化改进 🟡

### 8.1 增强 to_dict 方法
- [ ] 支持关系序列化
- [ ] 处理循环引用
- [ ] 支持字段排除和包含
- [ ] 添加自定义序列化器

### 8.2 API 响应模型
- [ ] 创建 Pydantic 模型用于 API 响应
- [ ] 实现模型到 Pydantic 的转换
- [ ] 支持字段级权限控制

## 9. 测试和文档 🟡

### 9.1 模型测试
- [ ] 为每个模型创建单元测试
- [ ] 测试所有验证规则
- [ ] 测试关系和级联操作
- [ ] 测试软删除逻辑

### 9.2 文档完善
- [ ] 为每个模型添加详细文档字符串
- [ ] 创建模型关系图
- [ ] 编写模型使用指南
- [ ] 创建迁移指南

## 10. 数据迁移 🔴

### 10.1 修复现有数据
- [ ] 迁移 EmailAccount 的主键类型
- [ ] 修复 user_id 类型不一致
- [ ] 填充缺失的默认值

### 10.2 创建迁移脚本
- [ ] 使用 Alembic 创建迁移脚本
- [ ] 添加数据验证步骤
- [ ] 创建回滚方案

## 实施计划

### 第一阶段（1-2周）
- 完成所有 🔴 高优先级任务
- 重点解决模型一致性和业务逻辑分离

### 第二阶段（2-3周）
- 完成所有 🟡 中优先级任务
- 重点提升代码质量和可维护性

### 第三阶段（3-4周）
- 完成所有 🟢 低优先级任务
- 添加高级特性和性能优化

## 注意事项

1. **向后兼容**：所有改动需要考虑向后兼容性
2. **逐步迁移**：大的改动应该分步骤进行
3. **充分测试**：每个改动都需要充分的测试覆盖
4. **文档同步**：代码改动需要同步更新文档