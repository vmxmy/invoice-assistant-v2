# Camelot + invoice2data 融合方案分析

## 测试结果

### 整体表现
- **总体成功率**: 25/28 (89.3%)
- **Camelot表格提取率**: 25/28 (89.3%)
- **invoice2data模板匹配率**: 23/28 (82.1%)

### 字段提取率
| 字段 | 提取成功率 | 对比单独Camelot | 对比单独invoice2data |
|------|------------|-----------------|---------------------|
| 发票号码 | 89.3% | 100% ↓ | 100% ↓ |
| 开票日期 | 89.3% | 100% ↓ | 100% ↓ |
| 含税金额 | 89.3% | 32.1% ↑ | 96.8% ↓ |
| 采购方 | 28.6% | 100% ↓↓ | 56.5% ↓ |
| 销售方 | 89.3% | 32.1% ↑↑ | 33.9% ↑↑ |
| 项目名称 | 14.3% | 28.6% ↓ | 91.9% ↓↓ |

## 优势分析

1. **销售方识别大幅提升**：从32.1%提升到89.3%
2. **含税金额识别大幅提升**：从32.1%提升到89.3%
3. **大部分字段达到近90%**：除了采购方和项目名称

## 问题分析

### 1. 采购方识别率低（28.6%）
**原因**：
- invoice2data模板可能不适应Camelot转换后的文本格式
- 表格结构转文本时可能丢失了位置关系
- 买方信息的正则表达式可能需要调整

**对比**：
- 单独Camelot：100%（通过位置关系判断）
- 单独invoice2data：56.5%
- 融合方案：28.6%（最差）

### 2. 项目名称识别率低（14.3%）
**原因**：
- 项目信息在表格中的格式复杂
- invoice2data模板对项目格式的匹配过于严格

### 3. 失败的3个文件
- 有3个PDF文件Camelot未能提取到表格
- 这些可能是非标准格式的发票

## 技术实现细节

### 工作流程
1. **Camelot提取表格** → DataFrame格式
2. **转换为结构化文本** → 保持字段关系
3. **创建临时文本文件** → 供invoice2data处理
4. **invoice2data模板匹配** → 提取字段
5. **字段映射** → 标准化字段名
6. **备用提取** → invoice2data失败时的后备方案

### 关键代码
```python
# 将表格转换为结构化文本
def _convert_tables_to_structured_text(self, tables):
    # 保持字段和值的关系
    if col_idx == 0 or ':' in cell_str:
        row_text.append(cell_str)
    else:
        # 如果前一个是标签，用冒号连接
        if row_text and not row_text[-1].endswith((':', '：')):
            row_text[-1] += '：' + cell_str
```

## 改进建议

### 1. 优化采购方提取
- 调整invoice2data模板的buyer_name正则表达式
- 在文本转换时更好地保留买方卖方的位置关系
- 考虑添加专门的买方识别逻辑

### 2. 混合策略
- 对于采购方：优先使用Camelot的位置判断
- 对于金额和销售方：使用invoice2data的结果
- 对于项目信息：可能需要自定义提取逻辑

### 3. 模板优化
- 为Camelot转换后的文本格式创建专门的invoice2data模板
- 调整正则表达式以适应结构化文本格式

## 结论

### 融合方案的价值
1. **部分字段表现优异**：销售方和金额识别率大幅提升
2. **证明了融合的可行性**：两种工具可以互补
3. **暴露了关键问题**：采购方识别需要特别处理

### 最终建议

**继续使用优化后的混合方案**：
1. **Camelot + 坐标提取**：用于采购方识别（100%成功率）
2. **Camelot + invoice2data**：用于销售方和金额识别（89.3%成功率）
3. **自定义逻辑**：用于项目信息提取

这样可以充分发挥各种方法的优势，实现最佳的整体提取效果。