# 邮件发票处理流程统一化实施计划

## 实施任务

- [ ] 1. 创建统一发票处理服务
  - 创建 UnifiedInvoiceProcessor 类，封装完整的 OCR → 解析 → 保存流程
  - 实现统一的发票文件处理入口方法
  - 集成现有的 OCR 服务、数据解析器和发票服务
  - 集成现有的适配器系统，实现发票类型识别和适配器选择
  - 添加完整的错误处理和重试机制
  - _需求: 1.1, 2.1, 4.1_

- [ ] 2. 集成适配器系统
  - 分析现有的 VATInvoiceAdapter 和 TrainTicketAdapter 适配器
  - 在统一处理器中实现发票类型识别逻辑
  - 确保适配器能正确处理不同类型发票的商品明细
  - 实现适配器结果到标准数据结构的转换
  - _需求: 3.1, 7.1_

- [ ] 3. 重构 InvoiceService 核心逻辑
  - 提取 create_invoice_from_processed_data 方法
  - 实现 _build_extracted_data_with_standard_paths 方法
  - 修改现有的 create_or_update_from_file 方法使用统一处理器
  - 确保商品明细在多个路径下可用，兼容前端配置
  - _需求: 2.2, 3.2, 7.2_

- [ ] 4. 重构 AutomatedInvoiceProcessor
  - 删除 _call_ocr_service 方法，改用统一处理器
  - 删除 _create_invoice_record 方法，消除重复代码
  - 实现 _process_single_pdf 方法使用统一处理器
  - 简化批量处理逻辑，复用统一流程
  - _需求: 1.2, 2.3, 5.1_

- [ ] 5. 实现数据路径标准化
  - 分析前端 invoiceFieldsConfig.ts 中的 valuePaths 配置
  - 确保商品明细在所有标准路径下可用
  - 实现 extracted_data 结构的标准化，包含多层级路径
  - 添加单元测试验证所有路径的数据可访问性
  - _需求: 3.3, 7.3_

- [ ] 6. 添加统一错误处理
  - 实现 OCR 处理的重试机制和降级策略
  - 添加数据解析的部分失败处理逻辑
  - 统一发票创建的错误处理和事务管理
  - 实现详细的错误日志记录和监控
  - _需求: 4.2, 4.3_

- [ ] 7. 创建单元测试
  - 为 UnifiedInvoiceProcessor 编写完整的单元测试
  - 测试各种 OCR 响应格式的处理能力
  - 验证商品明细数据的完整性保存
  - 测试错误处理和重试机制的正确性
  - _需求: 1.3, 3.1_

- [ ] 8. 实现集成测试
  - 创建端到端的发票处理流程测试
  - 验证手动上传和邮件处理的数据一致性
  - 测试前端数据访问的兼容性
  - 验证批量处理的性能和稳定性
  - _需求: 2.1, 3.2, 5.2_

- [ ] 9. 数据迁移和兼容性验证
  - 创建数据迁移脚本，为现有发票补充标准路径数据
  - 验证历史数据的访问正常性
  - 测试现有 API 接口的向后兼容性
  - 确保前端显示功能不受影响
  - _需求: 6.1, 6.2, 6.3_

- [ ] 10. 性能优化和监控
  - 对统一处理流程进行性能测试和优化
  - 实现处理时间和资源使用的监控
  - 优化批量处理的内存使用
  - 添加关键指标的告警机制
  - _需求: 5.3_

- [ ] 11. 部署和验证
  - 在测试环境部署统一化的处理流程
  - 使用真实数据验证商品明细显示正常
  - 进行灰度发布，监控系统稳定性
  - 收集用户反馈，修复发现的问题
  - _需求: 6.1, 3.3_

- [ ] 12. 代码清理和废弃旧模块
  - 标识并删除 AutomatedInvoiceProcessor 中不再使用的方法
  - 删除重复的 OCR 调用和数据处理逻辑
  - 移除旧的邮件发票处理 API 端点，使用统一的 API
  - 清理不再使用的辅助函数和工具方法
  - _需求: 5.1, 5.2_

- [ ] 13. 文档更新和开发者指南
  - 更新 API 文档，说明统一化的处理流程
  - 更新开发者文档，说明新的架构设计
  - 创建故障排除指南和最佳实践文档
  - 添加适配器系统集成的详细说明
  - _需求: 5.2, 6.3_