# 邮件发票处理流程统一化需求文档

## 介绍

当前邮件发票处理和手动上传发票使用了不同的处理流程，导致商品明细等字段在邮件处理中丢失。本需求旨在统一两种处理流程，确保数据完整性和一致性。

## 需求

### 需求 1：统一OCR处理流程

**用户故事：** 作为系统开发者，我希望邮件发票和手动上传发票使用相同的OCR处理流程，以确保数据处理的一致性。

#### 验收标准

1. WHEN 邮件附件中的PDF发票被处理时 THEN 系统应使用与手动上传相同的OCR服务调用流程
2. WHEN OCR处理完成时 THEN 系统应使用相同的数据解析器处理OCR结果
3. WHEN 结构化数据生成时 THEN 系统应保持与手动上传相同的数据结构和字段映射

### 需求 2：统一发票创建流程

**用户故事：** 作为系统开发者，我希望所有发票创建都通过统一的发票服务，以确保数据保存的一致性。

#### 验收标准

1. WHEN 邮件发票需要创建时 THEN 系统应调用发票服务的统一创建方法
2. WHEN 发票数据保存时 THEN 系统应确保所有字段（包括商品明细）都被正确保存
3. WHEN 发票创建完成时 THEN 系统应返回与手动上传相同格式的响应数据

### 需求 3：保持商品明细完整性

**用户故事：** 作为用户，我希望通过邮件上传的发票能够正确显示商品明细信息，就像手动上传的发票一样。

#### 验收标准

1. WHEN 邮件发票包含商品明细时 THEN 系统应完整保存所有明细项目
2. WHEN 用户查看邮件上传的发票时 THEN 前端应能正确显示商品明细信息
3. WHEN 商品明细数据存在时 THEN 系统应在多个标准路径下保存数据以确保前端兼容性

### 需求 4：错误处理一致性

**用户故事：** 作为系统管理员，我希望邮件发票处理的错误处理机制与手动上传保持一致。

#### 验收标准

1. WHEN OCR处理失败时 THEN 系统应使用与手动上传相同的错误处理逻辑
2. WHEN 发票创建失败时 THEN 系统应提供一致的错误信息和恢复机制
3. WHEN 处理异常时 THEN 系统应记录详细的日志信息便于调试

### 需求 5：性能和可维护性

**用户故事：** 作为系统开发者，我希望统一的处理流程能够提高代码的可维护性和系统性能。

#### 验收标准

1. WHEN 代码重构完成时 THEN 系统应消除重复的OCR处理逻辑
2. WHEN 新功能需要添加时 THEN 开发者只需在一个地方修改OCR处理逻辑
3. WHEN 系统运行时 THEN 统一流程不应显著影响处理性能

### 需求 6：向后兼容性

**用户故事：** 作为系统用户，我希望现有的邮件发票处理功能在重构后仍能正常工作。

#### 验收标准

1. WHEN 系统重构完成时 THEN 现有的邮件扫描功能应继续正常工作
2. WHEN 用户查看历史发票时 THEN 所有数据应保持完整和可访问
3. WHEN API调用时 THEN 外部接口应保持兼容性

### 需求 7：数据路径标准化

**用户故事：** 作为前端开发者，我希望所有发票数据都遵循标准化的数据路径，便于统一处理。

#### 验收标准

1. WHEN 发票数据保存时 THEN 系统应在标准路径下保存所有关键字段
2. WHEN 前端查询数据时 THEN 系统应确保数据在预期的路径下可用
3. WHEN 数据结构变更时 THEN 系统应同时更新所有相关的数据路径