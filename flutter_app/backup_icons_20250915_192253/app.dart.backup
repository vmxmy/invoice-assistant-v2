import 'dart:async';
import 'package:flutter/cupertino.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:provider/provider.dart';
import 'core/config/app_config.dart';
import 'core/utils/logger.dart';
import 'core/di/injection_container.dart' as di;
import 'core/network/supabase_client.dart';
import 'core/theme/cupertino_theme_manager.dart';
import 'presentation/bloc/invoice_bloc.dart';
// import 'presentation/bloc/invoice_event.dart'; // æš‚æ—¶æœªä½¿ç”¨
import 'presentation/bloc/reimbursement_set_bloc.dart';
import 'presentation/bloc/permission_bloc.dart';
import 'presentation/utils/permission_preloader.dart';
import 'presentation/pages/main_page.dart';
import 'presentation/pages/login_page.dart';
import 'presentation/pages/register_page.dart';
import 'presentation/pages/invoice_detail_page.dart';
import 'presentation/pages/upload/ios_style_upload_page.dart';
import 'presentation/pages/reimbursement_set_detail_page.dart';
import 'presentation/pages/inbox/inbox_page.dart';
import 'presentation/bloc/inbox/inbox_bloc.dart';

/// å‘ç¥¨åŠ©æ‰‹åº”ç”¨æ ¹ç»„ä»¶
class InvoiceAssistantApp extends StatefulWidget {
  const InvoiceAssistantApp({super.key});

  @override
  State<InvoiceAssistantApp> createState() => _InvoiceAssistantAppState();
}

class _InvoiceAssistantAppState extends State<InvoiceAssistantApp> {
  late final CupertinoThemeManager _themeManager;
  late final PermissionPreloader _permissionPreloader;
  StreamSubscription<AuthState>? _authStateSubscription;

  @override
  void initState() {
    super.initState();
    _themeManager = CupertinoThemeManager();
    _permissionPreloader = PermissionPreloader();
    _initializeTheme();
    // å»¶è¿Ÿè®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨ï¼Œç¡®ä¿ MultiBlocProvider å®Œå…¨åˆå§‹åŒ–
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _setupAuthStateListener();
    });
  }

  /// åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
  Future<void> _initializeTheme() async {
    await _themeManager.initialize();
  }

  /// è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
  void _setupAuthStateListener() {
    _authStateSubscription = SupabaseClientManager.authStateStream.listen((authState) {
      // è·å–æ‰€æœ‰BLoCå¹¶å¤„ç†è®¤è¯çŠ¶æ€å˜æ›´
      if (mounted) {
        try {
          final permissionBloc = context.read<PermissionBloc>();
          final invoiceBloc = context.read<InvoiceBloc>();
          final reimbursementSetBloc = context.read<ReimbursementSetBloc>();
          
          _permissionPreloader.onAuthStateChanged(
            permissionBloc: permissionBloc,
            authState: authState,
            invoiceBloc: invoiceBloc,
            reimbursementSetBloc: reimbursementSetBloc,
          );
        } catch (e) {
          if (AppConfig.enableLogging) {
            AppLogger.error('è®¤è¯çŠ¶æ€ç›‘å¬å™¨è®¿é—® BLoC å¤±è´¥: $e', tag: 'App');
          }
        }
      }
    });
  }

  @override
  void dispose() {
    _authStateSubscription?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // è®°å½•åº”ç”¨å¯åŠ¨ä¿¡æ¯
    if (AppConfig.enableLogging) {
      AppLogger.info('å¯åŠ¨å‘ç¥¨åŠ©æ‰‹åº”ç”¨', tag: 'App');
    }

    return ChangeNotifierProvider.value(
      value: _themeManager,
      child: Consumer<CupertinoThemeManager>(
        builder: (context, themeManager, child) {
          return MultiBlocProvider(
            providers: [
              BlocProvider<InvoiceBloc>(
                create: (context) {
                  AppLogger.debug('åˆ›å»ºå…¨å±€å”¯ä¸€InvoiceBloc', tag: 'App');
                  final bloc = di.sl<InvoiceBloc>();
                  AppLogger.debug('InvoiceBlocå®ä¾‹åˆ›å»ºå®Œæˆ [${bloc.hashCode}]',
                      tag: 'App');
                  // ä¸åœ¨è¿™é‡Œç«‹å³åŠ è½½æ•°æ®ï¼Œç­‰åˆ°ç”¨æˆ·è®¤è¯å®Œæˆåå†åŠ è½½
                  // é¿å…åœ¨ Supabase åˆå§‹åŒ–å®Œæˆå‰è¯·æ±‚æ•°æ®
                  return bloc;
                },
              ),
              BlocProvider<ReimbursementSetBloc>(
                create: (context) {
                  AppLogger.debug('åˆ›å»ºå…¨å±€å”¯ä¸€ReimbursementSetBloc', tag: 'App');
                  final bloc = di.sl<ReimbursementSetBloc>();
                  AppLogger.debug(
                      'ReimbursementSetBlocå®ä¾‹åˆ›å»ºå®Œæˆ [${bloc.hashCode}]',
                      tag: 'App');
                  return bloc;
                },
              ),
              BlocProvider<PermissionBloc>(
                create: (context) {
                  AppLogger.debug('åˆ›å»ºå…¨å±€å”¯ä¸€PermissionBloc', tag: 'App');
                  final bloc = di.sl<PermissionBloc>();
                  AppLogger.debug(
                      'PermissionBlocå®ä¾‹åˆ›å»ºå®Œæˆ [${bloc.hashCode}]',
                      tag: 'App');
                  
                  // å¦‚æœç”¨æˆ·å·²ç™»å½•ä¸”é‚®ç®±å·²ç¡®è®¤ï¼Œä½¿ç”¨é¢„åŠ è½½å™¨æ™ºèƒ½åŠ è½½æƒé™
                  final user = SupabaseClientManager.currentUser;
                  if (user != null && user.emailConfirmedAt != null) {
                    // ä½¿ç”¨é¢„åŠ è½½å™¨è¿›è¡Œæ™ºèƒ½æƒé™é¢„åŠ è½½
                    WidgetsBinding.instance.addPostFrameCallback((_) {
                      _permissionPreloader.preloadPermissions(permissionBloc: bloc);
                    });
                  }
                  
                  return bloc;
                },
              ),
              BlocProvider<InboxBloc>(
                create: (context) {
                  AppLogger.debug('åˆ›å»ºå…¨å±€å”¯ä¸€InboxBloc', tag: 'App');
                  final bloc = di.sl<InboxBloc>();
                  AppLogger.debug(
                      'InboxBlocå®ä¾‹åˆ›å»ºå®Œæˆ [${bloc.hashCode}]',
                      tag: 'App');
                  return bloc;
                },
              ),
            ],
            child: CupertinoApp.router(
              title: AppConfig.appName,
              debugShowCheckedModeBanner: false,

              // ä½¿ç”¨ç®€åŒ–çš„ Cupertino ä¸»é¢˜
              theme: themeManager.themeData,

              // åº”ç”¨é…ç½®
              locale: const Locale('zh', 'CN'),
              
              // çº¯Cupertinoæœ¬åœ°åŒ–æ”¯æŒ
              localizationsDelegates: const [
                GlobalCupertinoLocalizations.delegate,
                GlobalWidgetsLocalizations.delegate,
              ],
              supportedLocales: const [
                Locale('zh', 'CN'),
                Locale('en', 'US'),
              ],

              // è·¯ç”±é…ç½®
              routerConfig: _router,

              // å…¨å±€å¯¼èˆªé…ç½®
              builder: (context, child) {
                return MediaQuery(
                  // å¼ºåˆ¶æ–‡å­—ç¼©æ”¾ä¸º1.0ï¼Œä¿æŒè®¾è®¡ä¸€è‡´æ€§
                  data: MediaQuery.of(context)
                      .copyWith(textScaler: const TextScaler.linear(1.0)),
                  child: child!,
                );
              },
            ),
          );
        },
      ),
    );
  }

}

/// ğŸ” ä¼šè¯å®‰å…¨éªŒè¯ç»“æœ
class SessionValidationResult {
  final bool isValid;
  final String status;
  final String? failureReason;
  final Map<String, dynamic> details;
  
  SessionValidationResult({
    required this.isValid,
    required this.status,
    this.failureReason,
    this.details = const {},
  });
}

/// ğŸ” å®‰å…¨å¢å¼ºï¼šå…¨é¢çš„ä¼šè¯å®‰å…¨éªŒè¯
SessionValidationResult _validateSessionSecurity() {
  try {
    final session = SupabaseClientManager.client.auth.currentSession;
    final user = SupabaseClientManager.currentUser;
    
    // åŸºç¡€éªŒè¯ï¼šä¼šè¯å’Œç”¨æˆ·å­˜åœ¨æ€§
    if (session == null || user == null) {
      return SessionValidationResult(
        isValid: false,
        status: 'NO_SESSION',
        failureReason: 'ä¼šè¯æˆ–ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨',
        details: {
          'hasSession': session != null,
          'hasUser': user != null,
        },
      );
    }
    
    // ğŸš¨ å®‰å…¨éªŒè¯1ï¼šé‚®ç®±ç¡®è®¤æ£€æŸ¥
    if (user.emailConfirmedAt == null) {
      return SessionValidationResult(
        isValid: false,
        status: 'EMAIL_NOT_CONFIRMED',
        failureReason: 'é‚®ç®±æœªç¡®è®¤',
        details: {
          'userEmail': user.email,
          'emailConfirmedAt': null,
        },
      );
    }
    
    // ğŸš¨ å®‰å…¨éªŒè¯2ï¼šä¼šè¯è¿‡æœŸæ£€æŸ¥
    final now = DateTime.now().millisecondsSinceEpoch / 1000;
    if (session.expiresAt != null && session.expiresAt! <= now) {
      return SessionValidationResult(
        isValid: false,
        status: 'SESSION_EXPIRED',
        failureReason: 'ä¼šè¯å·²è¿‡æœŸ',
        details: {
          'expiresAt': session.expiresAt,
          'currentTime': now,
          'expiredSeconds': now - session.expiresAt!,
        },
      );
    }
    
    // ğŸš¨ å®‰å…¨éªŒè¯3ï¼šTokenæ ¼å¼éªŒè¯
    if (session.accessToken.isEmpty) {
      return SessionValidationResult(
        isValid: false,
        status: 'INVALID_TOKEN',
        failureReason: 'AccessTokenä¸ºç©º',
      );
    }
    
    // éªŒè¯JWTæ ¼å¼ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    final tokenParts = session.accessToken.split('.');
    if (tokenParts.length != 3) {
      return SessionValidationResult(
        isValid: false,
        status: 'MALFORMED_JWT',
        failureReason: 'JWTæ ¼å¼é”™è¯¯',
        details: {
          'tokenParts': tokenParts.length,
        },
      );
    }
    
    // ğŸš¨ å®‰å…¨éªŒè¯4ï¼šç”¨æˆ·è§’è‰²éªŒè¯ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
    final userMetadata = user.userMetadata;
    if (userMetadata != null && userMetadata.containsKey('banned') && userMetadata['banned'] == true) {
      return SessionValidationResult(
        isValid: false,
        status: 'USER_BANNED',
        failureReason: 'ç”¨æˆ·å·²è¢«ç¦ç”¨',
      );
    }
    
    // ğŸš¨ å®‰å…¨éªŒè¯5ï¼šä¼šè¯æ—¶é•¿æ£€æŸ¥ï¼ˆé˜²æ­¢å¼‚å¸¸é•¿æœŸä¼šè¯ï¼‰
    final sessionDuration = now - DateTime.now().millisecondsSinceEpoch / 1000;
    const maxSessionDuration = 24 * 60 * 60; // 24å°æ—¶
    if (sessionDuration > maxSessionDuration) {
      if (AppConfig.enableLogging) {
        AppLogger.warning('ğŸš¨ [Security] æ£€æµ‹åˆ°å¼‚å¸¸é•¿æœŸä¼šè¯: ${sessionDuration / 3600}å°æ—¶', tag: 'Security');
      }
    }
    
    // âœ… æ‰€æœ‰éªŒè¯é€šè¿‡
    return SessionValidationResult(
      isValid: true,
      status: 'VALID',
      details: {
        'userEmail': user.email,
        'emailConfirmedAt': user.emailConfirmedAt?.toString(),
        'sessionExpiresAt': session.expiresAt != null 
            ? DateTime.fromMillisecondsSinceEpoch((session.expiresAt! * 1000).round()).toIso8601String()
            : null,
        'sessionDurationHours': (sessionDuration / 3600).toStringAsFixed(2),
        'tokenValid': true,
      },
    );
    
  } catch (e) {
    if (AppConfig.enableLogging) {
      AppLogger.error('ğŸš¨ [Security] ä¼šè¯éªŒè¯å¼‚å¸¸', tag: 'Security', error: e);
    }
    return SessionValidationResult(
      isValid: false,
      status: 'VALIDATION_ERROR',
      failureReason: 'ä¼šè¯éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: $e',
    );
  }
}

/// åº”ç”¨è·¯ç”±é…ç½®
final _router = GoRouter(
  initialLocation: '/',
  refreshListenable:
      GoRouterRefreshStream(SupabaseClientManager.authStateStream),
  redirect: (context, state) {
    // ğŸš¨ å®‰å…¨å¢å¼ºï¼šå…¨é¢çš„ä¼šè¯éªŒè¯
    final validationResult = _validateSessionSecurity();
    final isFullyAuthenticated = validationResult.isValid;
    
    final isLoginPage = state.uri.toString() == '/login';
    final isRegisterPage = state.uri.toString() == '/register';

    if (AppConfig.enableLogging) {
      AppLogger.debug('ğŸ”— [Navigation] è·¯ç”±é‡å®šå‘æ£€æŸ¥', tag: 'Navigation');
      AppLogger.debug('ğŸ”— [Navigation] ç›®æ ‡è·¯ç”±: ${state.uri}', tag: 'Navigation');
      AppLogger.debug('ğŸ”— [Navigation] ä¼šè¯éªŒè¯çŠ¶æ€: ${validationResult.status}', tag: 'Navigation');
      AppLogger.debug('ğŸ”— [Navigation] å®Œå…¨è®¤è¯çŠ¶æ€: $isFullyAuthenticated', tag: 'Navigation');
      AppLogger.debug('ğŸ”— [Navigation] æ˜¯ç™»å½•é¡µ: $isLoginPage', tag: 'Navigation');
      AppLogger.debug('ğŸ”— [Navigation] æ˜¯æ³¨å†Œé¡µ: $isRegisterPage', tag: 'Navigation');
      AppLogger.debug('ğŸ”— [Navigation] æ—¶é—´æˆ³: ${DateTime.now().toIso8601String()}', tag: 'Navigation');
      
      // æ˜¾ç¤ºè¯¦ç»†çš„å®‰å…¨éªŒè¯ä¿¡æ¯
      if (validationResult.details.isNotEmpty) {
        AppLogger.debug('ğŸ”— [Navigation] éªŒè¯è¯¦æƒ…: ${validationResult.details}', tag: 'Navigation');
      }
      if (!validationResult.isValid && validationResult.failureReason != null) {
        AppLogger.warning('ğŸš¨ [Security] ä¼šè¯éªŒè¯å¤±è´¥: ${validationResult.failureReason}', tag: 'Navigation');
      }
    }

    // ğŸš¨ å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæœªé€šè¿‡å®‰å…¨éªŒè¯ä¸”ä¸åœ¨ç™»å½•é¡µæˆ–æ³¨å†Œé¡µï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
    if (!isFullyAuthenticated && !isLoginPage && !isRegisterPage) {
      if (AppConfig.enableLogging) {
        AppLogger.warning('ğŸš¨ [Security] é‡å®šå‘åˆ°ç™»å½•é¡µ: ${validationResult.failureReason ?? 'æœªçŸ¥åŸå› '}', tag: 'Navigation');
      }
      return '/login';
    }

    // å¦‚æœå·²å®Œå…¨è®¤è¯ä¸”åœ¨ç™»å½•é¡µæˆ–æ³¨å†Œé¡µï¼Œé‡å®šå‘åˆ°ä¸»é¡µ
    if (isFullyAuthenticated && (isLoginPage || isRegisterPage)) {
      if (AppConfig.enableLogging) {
        AppLogger.debug('ğŸ”— [Navigation] é‡å®šå‘åˆ°ä¸»é¡µ (å·²å®Œå…¨è®¤è¯)', tag: 'Navigation');
      }
      return '/';
    }

    return null;
  },
  routes: [
    GoRoute(
      path: '/',
      name: 'home',
      builder: (context, state) => const MainPage(),
    ),
    GoRoute(
      path: '/login',
      name: 'login',
      builder: (context, state) => LoginPage(
        onLoginSuccess: () {
          context.go('/');
        },
      ),
    ),
    GoRoute(
      path: '/register',
      name: 'register',
      builder: (context, state) => RegisterPage(
        onRegisterSuccess: () {
          context.go('/');
        },
      ),
    ),
    GoRoute(
      path: '/invoice-detail/:id',
      name: 'invoice-detail',
      builder: (context, state) {
        final invoiceId = state.pathParameters['id']!;
        // Note: InvoiceDetailPage will access InvoiceBloc from MainPage's BlocProvider
        // This route should only be accessible from within the main app flow
        return InvoiceDetailPage(invoiceId: invoiceId);
      },
    ),
    GoRoute(
      path: '/upload',
      name: 'upload',
      builder: (context, state) => const IOSStyleUploadPage(),
    ),
    GoRoute(
      path: '/reimbursement-set/:id',
      name: 'reimbursement-set-detail',
      builder: (context, state) {
        final setId = state.pathParameters['id']!;
        // Note: ReimbursementSetDetailPage will access ReimbursementSetBloc from MainPage's BlocProvider
        // This route should only be accessible from within the main app flow
        return ReimbursementSetDetailPage(reimbursementSetId: setId);
      },
    ),
    GoRoute(
      path: '/inbox',
      name: 'inbox',
      builder: (context, state) {
        // Note: InboxPage will access InboxBloc from MainPage's BlocProvider
        // This route should only be accessible from within the main app flow
        return const InboxPage();
      },
    ),
  ],
);

/// ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–çš„åˆ·æ–°æµ
class GoRouterRefreshStream extends ChangeNotifier {
  late final StreamSubscription _subscription;

  GoRouterRefreshStream(Stream<AuthState> stream) {
    notifyListeners();
    _subscription = stream.asBroadcastStream().listen((_) {
      notifyListeners();
    });
  }

  @override
  void dispose() {
    _subscription.cancel();
    super.dispose();
  }
}
