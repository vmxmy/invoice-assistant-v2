#!/usr/bin/env python3
"""
è°ƒè¯•é£çŒªèˆªç©ºå‘ç¥¨æ­£åˆ™è¡¨è¾¾å¼
"""

import re
import fitz  # PyMuPDF
from pathlib import Path

def debug_regex():
    """è°ƒè¯•æ­£åˆ™è¡¨è¾¾å¼"""
    
    pdf_path = "/Users/xumingyang/app/invoice_assist/downloads/æŠ¥é”€/invoices_20250326164322/2025-03-26-é˜¿æ–¯å…°èˆªç©ºæœåŠ¡ï¼ˆä¸Šæµ·ï¼‰æœ‰é™å…¬å¸-192.00-25317000000510550926.pdf"
    
    if not Path(pdf_path).exists():
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {pdf_path}")
        return
    
    print("ğŸ”§ è°ƒè¯•é£çŒªèˆªç©ºå‘ç¥¨æ­£åˆ™è¡¨è¾¾å¼")
    print("=" * 80)
    
    # æ‰“å¼€PDF
    doc = fitz.open(pdf_path)
    text = ""
    for page in doc:
        text += page.get_text()
    doc.close()
    
    print("ğŸ“„ PDFæ–‡æœ¬å†…å®¹:")
    print("-" * 40)
    print(text[:1000])  # æ˜¾ç¤ºå‰1000ä¸ªå­—ç¬¦
    print("...")
    print("-" * 40)
    
    # æµ‹è¯•ä¸åŒçš„æ­£åˆ™è¡¨è¾¾å¼
    patterns = [
        # è´­ä¹°æ–¹åç§°
        ('è´­ä¹°æ–¹åç§°1', r'è´­\s*ä¹°\s*æ–¹[\s\S]*?åç§°[ï¼š:]\s*([^\n]+)'),
        ('è´­ä¹°æ–¹åç§°2', r'åç§°[ï¼š:]\s*([^\n]+).*?ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç '),
        ('è´­ä¹°æ–¹åç§°3', r'è´­ä¹°æ–¹ä¿¡æ¯\s*åç§°[ï¼š:]\s*([^\n]+)'),
        ('è´­ä¹°æ–¹åç§°4', r'è´­\s*ä¹°\s*æ–¹\s*ä¿¡\s*æ¯\s*åç§°[ï¼š:]\s*([^\n]+)'),
        ('è´­ä¹°æ–¹åç§°5', r'æ¯\s*åç§°[ï¼š:]\s*([^\n]+)\s*ç»Ÿä¸€ç¤¾ä¼š'),
        
        # è´­ä¹°æ–¹ç¨å·
        ('è´­ä¹°æ–¹ç¨å·1', r'è´­\s*ä¹°\s*æ–¹[\s\S]*?ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /çº³ç¨äººè¯†åˆ«å·[ï¼š:]\s*([A-Z0-9]{15,20})'),
        ('è´­ä¹°æ–¹ç¨å·2', r'ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /çº³ç¨äººè¯†åˆ«å·[ï¼š:]\s*([A-Z0-9]{15,20}).*?é”€'),
        ('è´­ä¹°æ–¹ç¨å·3', r'çº³ç¨äººè¯†åˆ«å·[ï¼š:]\s*([A-Z0-9]{15,20})'),
        
        # é”€å”®æ–¹åç§°
        ('é”€å”®æ–¹åç§°1', r'é”€\s*å”®\s*æ–¹[\s\S]*?åç§°[ï¼š:]\s*([^\n]+)'),
        ('é”€å”®æ–¹åç§°2', r'é”€\s*å”®\s*æ–¹\s*ä¿¡\s*æ¯\s*åç§°[ï¼š:]\s*([^\n]+)'),
        ('é”€å”®æ–¹åç§°3', r'é”€.*?åç§°[ï¼š:]\s*([^\n]+)\s*ç»Ÿä¸€ç¤¾ä¼š'),
        
        # é”€å”®æ–¹ç¨å·
        ('é”€å”®æ–¹ç¨å·1', r'é”€\s*å”®\s*æ–¹[\s\S]*?ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /çº³ç¨äººè¯†åˆ«å·[ï¼š:]\s*([A-Z0-9]{15,20})'),
        ('é”€å”®æ–¹ç¨å·2', r'é”€å”®æ–¹.*?çº³ç¨äººè¯†åˆ«å·[ï¼š:]\s*([A-Z0-9]{15,20})'),
    ]
    
    print("\nğŸ” æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•:")
    print("-" * 40)
    
    for name, pattern in patterns:
        matches = re.findall(pattern, text, re.DOTALL | re.MULTILINE)
        if matches:
            print(f"âœ… {name}: {matches}")
        else:
            print(f"âŒ {name}: æ— åŒ¹é…")
    
    # æå–ç‰¹å®šéƒ¨åˆ†è¿›è¡Œåˆ†æ
    print("\nğŸ“‹ æ–‡æœ¬ç‰‡æ®µåˆ†æ:")
    print("-" * 40)
    
    # æŸ¥æ‰¾è´­ä¹°æ–¹éƒ¨åˆ†
    buyer_match = re.search(r'è´­\s*ä¹°\s*æ–¹.*?é”€\s*å”®\s*æ–¹', text, re.DOTALL)
    if buyer_match:
        print("è´­ä¹°æ–¹éƒ¨åˆ†:")
        print(repr(buyer_match.group(0)))
        print()
    
    # æŸ¥æ‰¾é”€å”®æ–¹éƒ¨åˆ†
    seller_match = re.search(r'é”€\s*å”®\s*æ–¹.*?é¡¹ç›®åç§°', text, re.DOTALL)
    if seller_match:
        print("é”€å”®æ–¹éƒ¨åˆ†:")
        print(repr(seller_match.group(0)))

if __name__ == "__main__":
    debug_regex()