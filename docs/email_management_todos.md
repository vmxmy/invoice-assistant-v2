# 邮箱管理和扫描功能开发计划

## 概述
本文档详细规划了邮箱管理和扫描功能的开发任务，包括邮箱账户管理、邮件扫描、发票识别等核心功能。

## 任务列表

### 核心功能开发（高优先级）

#### 数据模型层
- [ ] **email-1**: 创建邮箱账户数据模型 (EmailAccount)
  - 包含邮箱地址、密码、IMAP配置、用户关联等字段
  - 支持多种邮箱服务商（QQ、163、126、Gmail、Outlook等）
  
- [ ] **email-2**: 创建邮箱账户Schema定义
  - EmailAccountCreate: 创建邮箱账户的请求模型
  - EmailAccountUpdate: 更新邮箱账户的请求模型
  - EmailAccountResponse: 邮箱账户的响应模型
  - EmailAccountInDB: 数据库中的完整模型
  
- [ ] **email-9**: 添加邮箱密码加密存储
  - 使用加密算法保护邮箱密码
  - 实现加密和解密工具函数

#### 服务层
- [ ] **email-3**: 实现邮箱账户服务层 (EmailAccountService)
  - 增删改查功能
  - 密码加密/解密
  - IMAP配置验证
  - 连接测试功能

#### API层
- [ ] **email-4**: 创建邮箱账户API端点
  - GET /api/v1/email-accounts - 获取邮箱账户列表
  - POST /api/v1/email-accounts - 创建邮箱账户
  - PUT /api/v1/email-accounts/{id} - 更新邮箱账户
  - DELETE /api/v1/email-accounts/{id} - 删除邮箱账户
  - POST /api/v1/email-accounts/{id}/test - 测试邮箱连接

- [ ] **email-20**: 前端集成
  - 创建邮箱管理页面
  - 实现邮箱账户的增删改查UI
  - 添加连接测试功能
  - 集成扫描功能界面

### 扫描功能开发（中优先级）

#### 扫描任务管理
- [ ] **email-5**: 创建邮箱扫描任务模型 (EmailScanJob)
  - 任务状态（pending, running, completed, failed）
  - 扫描参数（日期范围、文件夹、过滤规则）
  - 结果统计（扫描邮件数、识别发票数、下载文件数）

- [ ] **email-6**: 实现邮箱扫描服务 (EmailScannerService)
  - 扫描邮箱获取邮件列表
  - 识别发票相关邮件
  - 下载发票附件
  - 更新扫描进度
  - 处理扫描结果

- [ ] **email-7**: 创建邮箱扫描API端点
  - POST /api/v1/email-scan/jobs - 创建扫描任务
  - GET /api/v1/email-scan/jobs/{id} - 查询任务状态
  - GET /api/v1/email-scan/jobs - 获取任务列表
  - GET /api/v1/email-scan/jobs/{id}/results - 获取扫描结果

#### 邮件处理
- [ ] **email-10**: 实现发票邮件识别规则
  - 基于邮件主题关键词（发票、invoice、账单等）
  - 基于发件人地址（已知的发票发送方）
  - 基于附件类型（PDF、图片等）
  - 可配置的识别规则

- [ ] **email-11**: 集成现有OCR流程
  - 将下载的发票附件接入OCR处理
  - 自动创建发票记录
  - 关联邮件信息和发票数据

- [ ] **email-13**: 添加邮件去重机制
  - 基于邮件ID去重
  - 基于附件哈希值去重
  - 避免重复处理相同的发票

- [ ] **email-17**: 添加错误处理和重试机制
  - 网络异常处理
  - 认证失败处理
  - 邮箱连接超时处理
  - 自动重试机制

#### 测试
- [ ] **email-18**: 编写单元测试
  - 邮箱账户CRUD测试
  - 邮箱连接测试
  - 扫描功能测试
  - 邮件识别规则测试

### 增强功能（低优先级）

#### 用户体验优化
- [ ] **email-8**: 实现邮箱IMAP配置自动检测
  - 根据邮箱域名自动填充IMAP服务器
  - 常见邮箱服务商配置预设
  - 智能端口检测

- [ ] **email-12**: 实现扫描进度实时更新
  - WebSocket实时推送进度
  - 或使用轮询机制
  - 显示当前处理的邮件信息

- [ ] **email-14**: 实现扫描历史记录
  - 记录每次扫描的详细信息
  - 扫描时间、结果统计
  - 处理的邮件列表

- [ ] **email-15**: 添加邮箱文件夹选择功能
  - 列出邮箱所有文件夹
  - 允许用户选择扫描的文件夹
  - 支持多文件夹扫描

- [ ] **email-16**: 实现定时扫描功能
  - 配置定时任务
  - 支持按天、周、月定时扫描
  - 自动执行扫描并通知结果

- [ ] **email-19**: 更新API文档
  - 添加邮箱管理相关接口文档
  - 更新OpenAPI规范
  - 添加使用示例

## 实施顺序

1. **第一阶段**：基础架构（email-1, email-2, email-9, email-3）
2. **第二阶段**：API接口（email-4）
3. **第三阶段**：扫描核心（email-5, email-6, email-7）
4. **第四阶段**：邮件处理（email-10, email-11, email-13）
5. **第五阶段**：前端集成（email-20）
6. **第六阶段**：质量保证（email-17, email-18）
7. **第七阶段**：功能增强（email-8, email-12, email-14, email-15, email-16, email-19）

## 技术要点

1. **安全性**
   - 邮箱密码必须加密存储
   - API需要用户认证
   - 限制扫描频率防止滥用

2. **性能**
   - 大批量邮件扫描需要分页处理
   - 附件下载使用异步处理
   - 合理设置超时时间

3. **兼容性**
   - 支持主流邮箱服务商
   - 处理不同的字符编码
   - 兼容各种附件格式

4. **可维护性**
   - 清晰的代码结构
   - 完善的错误日志
   - 可配置的业务规则