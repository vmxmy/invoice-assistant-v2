# å‰ç«¯ Edge Function é›†æˆå®Œæˆ

## ğŸ¯ æ›´æ–°ç›®æ ‡
å°†å‰ç«¯å®Œå…¨é€‚é… Edge Function è¿”å›çš„æ•°æ®ç»“æ„ï¼Œæä¾›æ›´æ™ºèƒ½çš„OCRç»“æœå¤„ç†å’Œç”¨æˆ·ä½“éªŒã€‚

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. æ•°æ®å¯ç”¨æ€§åˆ¤æ–­é€»è¾‘æ›´æ–°
**ä¹‹å‰**: ç®€å•åˆ¤æ–­ `success` å­—æ®µï¼Œå¤±è´¥å³æŠ¥é”™
```typescript
if (!ocrResponse || !ocrResponse.success) {
  throw new Error('OCRè¯†åˆ«å¤±è´¥');
}
```

**ç°åœ¨**: æ™ºèƒ½æ•°æ®è´¨é‡è¯„ä¼°
```typescript
const hasValidData = ocrResponse.fields && 
                    Object.keys(ocrResponse.fields).length > 0 && 
                    ocrResponse.confidence?.overall > 0.5;

if (!hasValidData) {
  throw new Error(ocrResponse.error || 'OCRæ•°æ®æå–å¤±è´¥');
}
```

### 2. æ–°å¢ OCR è´¨é‡è¯„ä¼°å‡½æ•°
```typescript
function assessOCRQuality(ocrResponse: any): {
  status: UploadFile['status']; 
  progress: number; 
  message: string 
}
```

**è¯„ä¼°æ ‡å‡†**:
- `success: true` + é«˜ç½®ä¿¡åº¦ â†’ 90% è¿›åº¦ï¼Œ"è¯†åˆ«å®Œæˆ"
- å®Œæ•´æ€§â‰¥70% + ç½®ä¿¡åº¦â‰¥90% â†’ 80% è¿›åº¦ï¼Œ"è¯†åˆ«åŸºæœ¬å®Œæˆ" 
- å®Œæ•´æ€§â‰¥50% + ç½®ä¿¡åº¦â‰¥80% â†’ 70% è¿›åº¦ï¼Œ"è¯†åˆ«éƒ¨åˆ†å®Œæˆ"
- å®Œæ•´æ€§â‰¥30% + ç½®ä¿¡åº¦â‰¥60% â†’ 60% è¿›åº¦ï¼Œ"è¯†åˆ«è´¨é‡è¾ƒä½"
- å…¶ä»–æƒ…å†µ â†’ é”™è¯¯çŠ¶æ€

### 3. UploadFile æ¥å£æ‰©å±•
æ–°å¢ Edge Function ç‰¹æœ‰å­—æ®µ:
```typescript
interface UploadFile {
  // åŸæœ‰å­—æ®µ...
  
  // Edge Functionç‰¹æœ‰å­—æ®µ
  qualityMessage?: string;        // è´¨é‡è¯„ä¼°æ¶ˆæ¯
  processingTime?: number;        // å¤„ç†æ—¶é—´(ms)
  completenessScore?: number;     // å®Œæ•´æ€§è¯„åˆ†(0-100)
  validationErrors?: string[];    // éªŒè¯é”™è¯¯åˆ—è¡¨
  validationWarnings?: string[];  // éªŒè¯è­¦å‘Šåˆ—è¡¨
}
```

### 4. UI æ˜¾ç¤ºå¢å¼º
åœ¨OCRç»“æœé¢„è§ˆå¡ç‰‡ä¸­æ–°å¢:

**è´¨é‡æŒ‡æ ‡æ˜¾ç¤º**:
- å®Œæ•´æ€§è¯„åˆ†å¾½ç«  (ç»¿è‰²â‰¥70%, é»„è‰²â‰¥50%, çº¢è‰²<50%)
- å¤„ç†æ—¶é—´æ˜¾ç¤º (å¸¦æ—¶é’Ÿå›¾æ ‡)

**è´¨é‡æ¶ˆæ¯**:
- ğŸ“Š è¯†åˆ«è´¨é‡è¯„ä¼°æ¶ˆæ¯

**éªŒè¯åé¦ˆ**:
- âŒ é”™è¯¯æç¤º (çº¢è‰²èƒŒæ™¯)
- âš ï¸ è­¦å‘Šæç¤º (é»„è‰²èƒŒæ™¯)

### 5. æ•°æ®å¤„ç†é€‚é…
å¢å¼º OCR æ•°æ®æå–:
```typescript
const ocrData = {
  invoice_type: ocrResponse.invoice_type,
  ...ocrResponse.fields,
  confidence: ocrResponse.confidence?.overall || 0,
  validation: ocrResponse.validation,
  processing_steps: ocrResponse.processing_steps,
  // Edge Functionç‰¹æœ‰çš„å…ƒæ•°æ®
  processing_time: ocrResponse.metadata?.total_processing_time,
  step_timings: ocrResponse.metadata?.step_timings,
  completeness_score: ocrResponse.validation?.completeness_score || 0
};
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. æ›´æ™ºèƒ½çš„çŠ¶æ€åˆ¤æ–­
- ä¸å†å› ä¸ºéªŒè¯è­¦å‘Šè€Œæ˜¾ç¤º"å¤±è´¥"
- æ ¹æ®æ•°æ®è´¨é‡æ˜¾ç¤ºä¸åŒçš„å®Œæˆåº¦
- æä¾›å…·ä½“çš„é—®é¢˜è¯´æ˜å’Œå»ºè®®

### 2. è¯¦ç»†çš„åé¦ˆä¿¡æ¯
- å®æ—¶æ˜¾ç¤ºå¤„ç†æ—¶é—´å’Œå®Œæ•´æ€§è¯„åˆ†
- æ¸…æ™°åŒºåˆ†é”™è¯¯å’Œè­¦å‘Š
- æä¾›å…·ä½“çš„ç¼ºå¤±å­—æ®µä¿¡æ¯

### 3. æ¸è¿›å¼æ•°æ®æ¥å—
- é«˜è´¨é‡æ•°æ®ç›´æ¥å¯ç”¨
- ä¸­ç­‰è´¨é‡æ•°æ®æç¤ºè¡¥å……
- ä½è´¨é‡æ•°æ®å»ºè®®é‡æ–°å¤„ç†

## ğŸ“Š å®é™…æ•ˆæœç¤ºä¾‹

### é«˜è´¨é‡è¯†åˆ« (success: false, completeness: 50%, confidence: 99.87%)
```
çŠ¶æ€: recognized (80% è¿›åº¦)
æ¶ˆæ¯: "è¯†åˆ«åŸºæœ¬å®Œæˆï¼Œå®Œæ•´æ€§ 50%"
æ˜¾ç¤º: ğŸŸ¡ å®Œæ•´æ€§ 50% | â± 2051ms
è­¦å‘Š: âš ï¸ ç¼ºå°‘å¿…å¡«å­—æ®µ: total_amount
```

### ä¸­ç­‰è´¨é‡è¯†åˆ« (success: false, completeness: 40%, confidence: 95%)
```
çŠ¶æ€: recognized (70% è¿›åº¦) 
æ¶ˆæ¯: "è¯†åˆ«éƒ¨åˆ†å®Œæˆï¼Œéœ€æ‰‹åŠ¨è¡¥å……"
æ˜¾ç¤º: ğŸ”´ å®Œæ•´æ€§ 40% | â± 1800ms
é”™è¯¯: âŒ ç¼ºå°‘å¿…å¡«å­—æ®µ: seller_name, total_amount
```

## ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹

### 1. å‘åå…¼å®¹
- ä¿æŒä¸åŸæœ‰åç«¯APIçš„å…¼å®¹æ€§
- è‡ªåŠ¨é€‚é…ä¸åŒçš„å“åº”æ ¼å¼
- ä¼˜é›…é™çº§å¤„ç†

### 2. é”™è¯¯å¤„ç†å¢å¼º
- è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œæç¤º
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- å¯æ“ä½œçš„ä¿®å¤å»ºè®®

### 3. æ€§èƒ½ç›‘æ§
- å®æ—¶æ˜¾ç¤ºå¤„ç†æ—¶é—´
- å„æ­¥éª¤è€—æ—¶åˆ†æ
- è´¨é‡æŒ‡æ ‡å¯è§†åŒ–

## ğŸ¯ æœ€ç»ˆç»“æœ

ç°åœ¨å‰ç«¯å¯ä»¥:
âœ… æ­£ç¡®å¤„ç† Edge Function çš„ `success: false` ä½†æ•°æ®å¯ç”¨çš„æƒ…å†µ
âœ… æ˜¾ç¤ºè¯¦ç»†çš„è´¨é‡è¯„ä¼°å’ŒéªŒè¯ä¿¡æ¯  
âœ… æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯å’Œè­¦å‘Šæç¤º
âœ… æ”¯æŒæ¸è¿›å¼çš„æ•°æ®è´¨é‡æ¥å—ç­–ç•¥
âœ… ä¿æŒä¸åŸæœ‰APIçš„å®Œå…¨å…¼å®¹æ€§

ç”¨æˆ·ç°åœ¨å¯ä»¥çœ‹åˆ°æ›´æ™ºèƒ½ã€æ›´è¯¦ç»†çš„OCRå¤„ç†ç»“æœï¼Œå³ä½¿éªŒè¯ä¸å®Œå…¨é€šè¿‡ä¹Ÿèƒ½è·å¾—å¯ç”¨çš„æ•°æ®å’Œæ˜ç¡®çš„æ”¹è¿›å»ºè®®ã€‚