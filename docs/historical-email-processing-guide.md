# å†å²é‚®ä»¶å¤„ç†æŒ‡å—

## æ¦‚è¿°
æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å¤„ç†å·²æ”¶åˆ°çš„å†å²é‚®ä»¶ä¸­çš„å‘ç¥¨PDFé™„ä»¶ï¼Œæ”¯æŒå¤šç§å¤„ç†æ–¹å¼ã€‚

## ğŸ¯ å¯ç”¨æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: Pipedream å†å²æ‰«æ (æ¨è)
**é€‚ç”¨åœºæ™¯**: äº‘ç«¯è‡ªåŠ¨åŒ–å¤„ç†ï¼Œæ— éœ€æœ¬åœ°ç¯å¢ƒ
**ä¼˜åŠ¿**: 
- äº‘ç«¯è¿è¡Œï¼Œç¨³å®šå¯é 
- æ”¯æŒå®šæ—¶æ‰§è¡Œ
- è‡ªåŠ¨é”™è¯¯é‡è¯•
- å¯è§†åŒ–ç›‘æ§

**ä½¿ç”¨æ­¥éª¤**:
1. åœ¨Pipedreamä¸­åˆ›å»ºæ–°çš„Workflow
2. ä½¿ç”¨ `scripts/pipedream-historical-emails.js` ä¸­çš„ä»£ç 
3. é…ç½®æ‚¨çš„é‚®ç®±å‚æ•°
4. è®¾ç½®æ‰«æå¤©æ•°ï¼ˆé»˜è®¤30å¤©ï¼‰
5. è¿è¡ŒWorkflow

### æ–¹æ¡ˆ2: æœ¬åœ°æ‰¹é‡å¤„ç†è„šæœ¬
**é€‚ç”¨åœºæ™¯**: éœ€è¦æœ¬åœ°æ§åˆ¶å’Œæ–‡ä»¶ä¿å­˜
**ä¼˜åŠ¿**:
- å®Œå…¨æœ¬åœ°æ§åˆ¶
- å¯ä¿å­˜é™„ä»¶åˆ°æœ¬åœ°
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- è¯¦ç»†çš„å¤„ç†æŠ¥å‘Š

**ä½¿ç”¨æ­¥éª¤**:
```bash
# 1. è¿›å…¥è„šæœ¬ç›®å½•
cd /Users/xumingyang/app/invoice_assist/v2/scripts

# 2. å®‰è£…ä¾èµ–
npm install imap mailparser

# 3. è¿è¡Œå¤„ç†è„šæœ¬
node process_historical_emails.js

# æˆ–è€…ä½¿ç”¨å¯åŠ¨è„šæœ¬
./run_historical_scan.sh
```

### æ–¹æ¡ˆ3: Supabase Edge Function
**é€‚ç”¨åœºæ™¯**: é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿä¸­
**ä¼˜åŠ¿**:
- ä¸ç°æœ‰æ¶æ„æ— ç¼é›†æˆ
- æ”¯æŒAPIè°ƒç”¨
- äº‘ç«¯å¤„ç†

**ä½¿ç”¨æ­¥éª¤**:
```bash
# éƒ¨ç½²Edge Function
supabase functions deploy historical-email-scanner

# è°ƒç”¨APIå¤„ç†å†å²é‚®ä»¶
curl -X POST "https://sfenhhtvcyslxplvewmt.supabase.co/functions/v1/historical-email-scanner" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email_config": {
      "user": "vmxmy@qq.com",
      "password": "lagrezfyfpnobgic"
    },
    "scan_config": {
      "days_back": 60,
      "max_emails": 100
    }
  }'
```

## ğŸ“‹ é…ç½®å‚æ•°

### é‚®ç®±é…ç½®
```javascript
{
  user: 'vmxmy@qq.com',
  password: 'lagrezfyfpnobgic', // QQé‚®ç®±æˆæƒç 
  host: 'imap.qq.com',
  port: 993,
  tls: true
}
```

### æ‰«æé…ç½®
```javascript
{
  daysBack: 90,        // æ‰«ææœ€è¿‘å¤šå°‘å¤©
  batchSize: 10,       // æ¯æ‰¹å¤„ç†å¤šå°‘å°é‚®ä»¶
  maxEmails: 500,      // æœ€å¤§å¤„ç†é‚®ä»¶æ•°
  saveLocal: true,     // æ˜¯å¦ä¿å­˜åˆ°æœ¬åœ°
  keywords: ['å‘ç¥¨', 'invoice', 'ç™¼ç¥¨'] // æœç´¢å…³é”®è¯
}
```

## ğŸ” é‚®ä»¶æœç´¢æ¡ä»¶

è„šæœ¬ä¼šæœç´¢ç¬¦åˆä»¥ä¸‹æ¡ä»¶çš„é‚®ä»¶ï¼š
- **æ—¶é—´èŒƒå›´**: æœ€è¿‘Nå¤©å†…æ”¶åˆ°çš„é‚®ä»¶
- **ä¸»é¢˜åŒ…å«**: "å‘ç¥¨"ã€"invoice"ã€"ç™¼ç¥¨"
- **æ­£æ–‡åŒ…å«**: "å‘ç¥¨"å…³é”®è¯
- **é™„ä»¶ç±»å‹**: PDFæ ¼å¼æ–‡ä»¶

## ğŸ“Š å¤„ç†æµç¨‹

1. **è¿æ¥é‚®ç®±**: ä½¿ç”¨IMAPè¿æ¥QQé‚®ç®±
2. **æœç´¢é‚®ä»¶**: æ ¹æ®æ¡ä»¶ç­›é€‰åŒ…å«å‘ç¥¨çš„é‚®ä»¶
3. **æå–é™„ä»¶**: è¯†åˆ«å¹¶æå–PDFé™„ä»¶
4. **OCRå¤„ç†**: è°ƒç”¨Supabase Edge Functionè¿›è¡ŒOCR
5. **æ•°æ®æå–**: ä½¿ç”¨LLMæå–ç»“æ„åŒ–å‘ç¥¨æ•°æ®
6. **ä¿å­˜æ•°æ®**: å­˜å‚¨åˆ°Supabaseæ•°æ®åº“
7. **ç”ŸæˆæŠ¥å‘Š**: è¾“å‡ºå¤„ç†ç»Ÿè®¡å’Œç»“æœ

## ğŸ“ˆ å¤„ç†ç»Ÿè®¡

æ¯æ¬¡å¤„ç†å®Œæˆåä¼šç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼š
```json
{
  "timestamp": "2024-01-29T10:00:00.000Z",
  "stats": {
    "totalEmails": 150,      // æ‰«æçš„é‚®ä»¶æ€»æ•°
    "processedEmails": 145,   // æˆåŠŸå¤„ç†çš„é‚®ä»¶æ•°
    "foundPDFs": 89,         // æ‰¾åˆ°çš„PDFé™„ä»¶æ•°
    "successfulUploads": 85,  // æˆåŠŸä¸Šä¼ çš„é™„ä»¶æ•°
    "errorCount": 4,         // é”™è¯¯æ•°é‡
    "successRate": "95.51%"  // æˆåŠŸç‡
  }
}
```

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. é‚®ç®±è¿æ¥å¤±è´¥
```
é”™è¯¯: IMAP connection failed
è§£å†³: 
- ç¡®è®¤QQé‚®ç®±å·²å¼€å¯IMAPæœåŠ¡
- ä½¿ç”¨æˆæƒç è€Œéç™»å½•å¯†ç 
- æ£€æŸ¥ç½‘ç»œè¿æ¥
```

### 2. PDFä¸æ”¯æŒOCR
```
é”™è¯¯: OCR processing failed
è§£å†³:
- æ£€æŸ¥PDFæ˜¯å¦ä¸ºæ‰«æç‰ˆï¼ˆå›¾ç‰‡ï¼‰
- ç¡®è®¤æ–‡ä»¶å¤§å°ä¸è¶…è¿‡é™åˆ¶
- å°è¯•è½¬æ¢PDFæ ¼å¼
```

### 3. æ•°æ®åº“å†™å…¥å¤±è´¥
```
é”™è¯¯: Database insertion failed
è§£å†³:
- æ£€æŸ¥Supabaseè¿æ¥é…ç½®
- ç¡®è®¤æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®
- æ£€æŸ¥å­—æ®µé•¿åº¦é™åˆ¶
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰OCRæœåŠ¡
å¦‚æœéœ€è¦ä½¿ç”¨å…¶ä»–OCRæœåŠ¡ï¼š
```javascript
// åœ¨process_historical_emails.jsä¸­ä¿®æ”¹
async processPDFAttachment(attachment, emailInfo) {
  // æ›¿æ¢ä¸ºæ‚¨çš„OCRæœåŠ¡
  const ocrResult = await yourCustomOCRService(attachment.content);
  // ...
}
```

### æ‰¹é‡é‡è¯•æœºåˆ¶
```javascript
// æ·»åŠ é‡è¯•é€»è¾‘
const maxRetries = 3;
for (let attempt = 1; attempt <= maxRetries; attempt++) {
  try {
    const result = await processPDF(attachment);
    break; // æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
  } catch (error) {
    if (attempt === maxRetries) throw error;
    await delay(attempt * 1000); // é€’å¢å»¶è¿Ÿ
  }
}
```

### å¢é‡å¤„ç†
```javascript
// é¿å…é‡å¤å¤„ç†å·²å¤„ç†è¿‡çš„é‚®ä»¶
const processedMessageIds = await getProcessedMessageIds();
if (processedMessageIds.includes(parsed.messageId)) {
  console.log('é‚®ä»¶å·²å¤„ç†ï¼Œè·³è¿‡...');
  return;
}
```

## ğŸ“… å®šæ—¶ä»»åŠ¡

### ä½¿ç”¨Cronå®šæ—¶æ‰§è¡Œ
```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰«ææ˜¨å¤©çš„é‚®ä»¶
0 2 * * * cd /path/to/scripts && node process_historical_emails.js

# æ¯å‘¨æ—¥æ‰«æä¸€å‘¨çš„é‚®ä»¶  
0 3 * * 0 cd /path/to/scripts && node process_historical_emails.js
```

### ä½¿ç”¨Pipedreamå®šæ—¶å™¨
åœ¨Pipedreamä¸­è®¾ç½®å®šæ—¶è§¦å‘å™¨ï¼Œå®šæœŸè¿è¡Œå†å²é‚®ä»¶æ‰«æã€‚

## ğŸ¯ æœ€ä½³å®è·µ

1. **åˆ†æ‰¹å¤„ç†**: é¿å…ä¸€æ¬¡å¤„ç†è¿‡å¤šé‚®ä»¶å¯¼è‡´è¶…æ—¶
2. **é”™è¯¯é‡è¯•**: å¯¹ä¸´æ—¶æ€§é”™è¯¯å®æ–½é‡è¯•æœºåˆ¶
3. **æ—¥å¿—è®°å½•**: è¯¦ç»†è®°å½•å¤„ç†è¿‡ç¨‹ä¾¿äºæ’é”™
4. **èµ„æºé™åˆ¶**: æ§åˆ¶å¹¶å‘æ•°é¿å…æœåŠ¡å™¨è¿‡è½½
5. **æ•°æ®å¤‡ä»½**: å¤„ç†å‰å¤‡ä»½é‡è¦æ•°æ®
6. **ç›‘æ§å‘Šè­¦**: è®¾ç½®å¼‚å¸¸æƒ…å†µçš„é€šçŸ¥æœºåˆ¶

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

- å¦¥å–„ä¿ç®¡é‚®ç®±æˆæƒç 
- ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- å®šæœŸæ›´æ–°APIå¯†é’¥
- å®¡æŸ¥å¤„ç†æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯
- è€ƒè™‘å¯¹å­˜å‚¨çš„æ–‡ä»¶è¿›è¡ŒåŠ å¯†