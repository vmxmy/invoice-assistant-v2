# 🚀 部署检查清单 - 策略A 渐进式迁移

## 📋 阶段1: 现代化部署

### 前端部署到 Vercel

#### 准备工作
- [ ] **代码推送**: 确保最新代码已推送到 GitHub
- [ ] **依赖检查**: `npm install` 在本地运行成功
- [ ] **构建测试**: `npm run build` 本地构建成功
- [ ] **类型检查**: `npm run type-check` 通过

#### Vercel 配置
- [ ] **项目创建**: 在 Vercel Dashboard 中创建新项目
- [ ] **仓库连接**: 连接到正确的 GitHub 仓库
- [ ] **根目录设置**: 设置 Root Directory 为 `frontend`
- [ ] **构建配置**: 框架预设自动检测为 "Vite"

#### 环境变量设置
- [ ] **VITE_SUPABASE_URL**: `https://sfenhhtvcyslxplvewmt.supabase.co`
- [ ] **VITE_SUPABASE_ANON_KEY**: 从 CLAUDE.md 获取的 anon key
- [ ] **VITE_API_URL**: 后端部署后的 URL (先用开发环境)
- [ ] **NODE_ENV**: `production`

#### 部署验证
- [ ] **网站访问**: Vercel 提供的 URL 可以正常访问
- [ ] **路由测试**: 直接访问 `/dashboard` 不出现 404
- [ ] **静态资源**: CSS、JS、图片正常加载
- [ ] **响应式**: 移动端显示正常

### 后端部署到 Railway/Render

#### 准备工作
- [ ] **Docker 测试**: 本地 Docker 构建和运行成功
- [ ] **环境变量**: 所有必需变量已准备
- [ ] **数据库连接**: 可以连接到 Supabase PostgreSQL
- [ ] **健康检查**: `/health` 端点正常响应

#### Railway 部署 (推荐)
- [ ] **CLI 安装**: `npm install -g @railway/cli`
- [ ] **登录**: `railway login` 成功
- [ ] **项目初始化**: `railway init` 创建项目
- [ ] **环境变量设置**: 所有必需变量已配置
- [ ] **部署**: `railway up` 成功

#### Render 部署 (备选)
- [ ] **服务创建**: 在 Render Dashboard 创建 Web Service
- [ ] **仓库连接**: 连接到正确的 GitHub 仓库  
- [ ] **根目录设置**: 设置为 `backend`
- [ ] **环境变量**: 在 Dashboard 中配置所有变量
- [ ] **自动部署**: Git push 触发自动部署

#### 部署验证
- [ ] **健康检查**: `GET /health` 返回正常状态
- [ ] **API 测试**: 主要端点正常响应
- [ ] **数据库**: 可以执行基本查询
- [ ] **认证**: JWT 验证正常工作
- [ ] **文件上传**: 上传功能正常

### 前后端集成测试

#### API 连接
- [ ] **CORS 配置**: 前端可以正常调用后端 API
- [ ] **认证流程**: 登录/注册功能正常
- [ ] **用户档案**: 可以获取和更新用户信息
- [ ] **发票管理**: 发票 CRUD 操作正常

#### 功能验证
- [ ] **用户注册**: 新用户可以成功注册
- [ ] **用户登录**: 已有用户可以正常登录
- [ ] **Dashboard**: 统计数据正确显示
- [ ] **发票列表**: 可以查看发票列表
- [ ] **文件上传**: 可以上传 PDF 文件

#### 性能检查
- [ ] **响应时间**: API 响应时间 < 2s
- [ ] **首屏加载**: 前端首屏加载 < 3s
- [ ] **Lighthouse**: 性能评分 > 80
- [ ] **错误监控**: 没有 JavaScript 错误

## 📊 成功指标

### 关键指标
- [ ] **可用性**: 99% 正常运行时间
- [ ] **性能**: 90% 的请求在 2s 内响应
- [ ] **错误率**: < 1% 的 HTTP 5xx 错误
- [ ] **用户体验**: 核心功能正常使用

### 监控设置
- [ ] **Vercel Analytics**: 前端性能监控
- [ ] **Railway/Render Logs**: 后端日志监控
- [ ] **Supabase Metrics**: 数据库性能监控
- [ ] **错误追踪**: 前后端错误收集

## 🔄 阶段2: API 迁移 (可选)

### 准备工作
- [ ] **优先级确定**: 选择要迁移的 API 端点
- [ ] **Serverless 函数**: 在 `api/` 目录创建函数
- [ ] **认证中间件**: 统一的 JWT 验证逻辑
- [ ] **错误处理**: 标准化错误响应

### 端点迁移
- [ ] **GET /api/v1/profiles/me**: 迁移到 `api/profiles/me.ts`
- [ ] **GET /api/v1/invoices/stats/overview**: 迁移到 `api/invoices/stats.ts`
- [ ] **GET /api/v1/invoices**: 迁移到 `api/invoices/index.ts`
- [ ] **并行测试**: 新旧端点同时运行
- [ ] **灰度切换**: 逐步切换到新端点

### 验证测试
- [ ] **功能对等**: 新端点功能与原端点一致
- [ ] **性能对比**: 响应时间不劣于原端点
- [ ] **错误处理**: 错误响应格式一致
- [ ] **并发测试**: 高并发下表现稳定

## 🚨 回滚计划

### 前端回滚
- [ ] **域名切换**: 修改 DNS 指向原服务器
- [ ] **环境变量**: 恢复原 API 地址配置
- [ ] **验证**: 确认原功能恢复正常

### 后端回滚  
- [ ] **服务重启**: 启动原 FastAPI 服务
- [ ] **负载均衡**: 切换流量到原服务
- [ ] **数据一致性**: 确认数据库状态一致

### 回滚触发条件
- [ ] **可用性**: 服务不可用超过 5 分钟
- [ ] **错误率**: 错误率超过 5%
- [ ] **性能**: 响应时间超过 10s
- [ ] **功能**: 核心功能无法使用

## 📞 团队沟通

### 部署前通知
- [ ] **时间窗口**: 通知维护时间窗口
- [ ] **影响范围**: 说明可能的服务影响
- [ ] **联系方式**: 提供紧急联系方式

### 部署后通知
- [ ] **完成确认**: 确认部署成功完成
- [ ] **新功能**: 介绍新功能和改进
- [ ] **反馈渠道**: 提供问题反馈渠道

## ✅ 最终确认

### 技术确认
- [ ] **所有测试通过**: 自动化和手动测试
- [ ] **性能达标**: 满足性能要求
- [ ] **安全检查**: 安全配置正确
- [ ] **监控就绪**: 监控和告警正常

### 业务确认
- [ ] **功能完整**: 所有核心功能正常
- [ ] **用户体验**: 用户可以正常使用
- [ ] **数据安全**: 用户数据安全可靠
- [ ] **服务稳定**: 服务稳定运行

## 📈 后续优化

### 短期 (1周内)
- [ ] **性能调优**: 基于监控数据优化性能
- [ ] **错误修复**: 修复发现的问题
- [ ] **用户反馈**: 收集和处理用户反馈

### 中期 (1个月内)
- [ ] **功能增强**: 添加新功能
- [ ] **API 迁移**: 完成更多端点迁移
- [ ] **成本优化**: 优化云服务成本

### 长期 (3个月内)
- [ ] **架构优化**: 进一步优化架构
- [ ] **扩容准备**: 为业务增长做准备
- [ ] **技术升级**: 升级到新技术版本

---

## 🎯 总结

这个检查清单确保了渐进式迁移的每个步骤都有明确的验证标准。通过分阶段实施，我们可以：

1. **最小化风险**: 每一步都有回滚方案
2. **确保质量**: 每个环节都有验证标准  
3. **提升体验**: 获得现代化部署的收益
4. **保持灵活**: 根据需要决定是否继续迁移

按照这个清单执行，可以确保部署过程的顺利进行和系统的稳定运行。